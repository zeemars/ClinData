# ClinData - 临床试验数据管理系统

## 项目简介

ClinData 是一个现代化的临床试验数据管理系统，旨在帮助医疗机构和研究人员高效管理、搜索和分析临床试验项目数据。系统提供了直观的用户界面和强大的管理功能，支持临床试验项目的全生命周期管理。

## 功能特性

### 🎯 核心功能

- **临床试验搜索**：支持按疾病、研究者、项目标题等多维度搜索
- **详细项目信息**：查看完整的临床试验项目详情，包括准入标准、联系方式等
- **管理员认证**：基于 Supabase Auth 的安全认证系统
- **权限管理**：支持超级管理员和数据管理员两种角色
- **数据管理**：创建、编辑、删除临床试验项目
- **批量数据导入**：支持从 CSV 文件批量导入数据
- **数据导出**：导出为 CSV 格式，方便离线分析
- **系统审计日志**：记录所有管理员操作，确保数据安全

### 📁 项目结构

```
ClinData/
├── components/          # 前端组件
│   ├── AdminDashboard.tsx   # 管理员面板
│   ├── AdminLogin.tsx       # 管理员登录
│   ├── SearchBox.tsx        # 搜索框
│   ├── TrialCard.tsx        # 试验卡片
│   └── TrialDetail.tsx      # 试验详情
├── lib/                 # 工具库
│   ├── crypto.ts            # 加密相关
│   └── supabase.ts          # Supabase 配置
├── services/            # 服务
│   └── gemini.ts            # Google GenAI 服务
├── App.tsx              # 主应用
├── types.ts             # 类型定义
└── vite.config.ts       # Vite 配置
```

## 技术栈

| 技术/依赖           | 版本          | 用途                          |
|--------------------|---------------|-------------------------------|
| React              | 19.2.4        | 前端框架                      |
| TypeScript         | 5.8.2         | 类型系统                      |
| Vite               | 6.2.0         | 构建工具                      |
| Supabase           | (外部导入)    | 数据库和认证服务              |
| Google GenAI       | 1.38.0        | AI 相关功能                   |

## 安装与运行

### 前置要求

- Node.js 18.0 或更高版本
- npm 9.0 或更高版本
- Supabase 项目账号（用于数据库和认证）

### 安装步骤

1. **克隆项目**

```bash
git clone <repository-url>
cd ClinData
```

2. **安装依赖**

```bash
npm install
```

3. **配置环境变量**

创建 `.env` 文件，添加以下配置：

```env
# Supabase 配置
VITE_SUPABASE_URL=<your-supabase-url>
VITE_SUPABASE_ANON_KEY=<your-supabase-anon-key>

# Google GenAI 配置（可选）
GEMINI_API_KEY=<your-gemini-api-key>
```

4. **启动开发服务器**

```bash
npm run dev
```

5. **构建生产版本**

```bash
npm run build
```

## 数据库配置

### 数据表结构

#### `trials` 表

| 字段名      | 数据类型    | 默认值      | 描述                |
|------------|------------|------------|--------------------|
| `id`       | `int8`     | `NULL`     | 主键，自增ID        |
| `department` | `text`    | `NULL`     | 科室                |
| `pi`       | `text`     | `NULL`     | 主研究者            |
| `title`    | `text`     | `NULL`     | 项目标题            |
| `disease`  | `text`     | `NULL`     | 适应症              |
| `tags`     | `text`     | `NULL`     | 标签（分号分隔）     |
| `criteria` | `text`     | `NULL`     | 详细准入标准        |
| `contact`  | `text`     | `NULL`     | 联系方式            |
| `created_at` | `timestamp` | `now()` | 创建时间            |

#### `admin_users` 表

| 字段名      | 数据类型    | 描述                |
|------------|------------|--------------------|
| `user_id`  | `text`     | Supabase Auth 用户ID |
| `role`     | `text`     | 角色（super_admin/data_admin） |

#### `logs` 表

| 字段名      | 数据类型    | 描述                |
|------------|------------|--------------------|
| `id`       | `int8`     | 主键，自增ID        |
| `created_at` | `timestamp` | 操作时间            |
| `user_id`  | `text`     | 操作用户ID          |
| `user_email` | `text`    | 操作用户邮箱        |
| `action`   | `text`     | 操作类型            |
| `details`  | `jsonb`    | 操作详情            |

### Supabase 配置

1. **创建 Supabase 项目**
   - 访问 [Supabase 控制台](https://supabase.com/dashboard)
   - 创建新的项目

2. **设置数据表**
   - 在 SQL 编辑器中运行以下 SQL 脚本创建所需的表结构：

```sql
-- 创建 trials 表
CREATE TABLE trials (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  department text,
  pi text,
  title text,
  disease text,
  tags text,
  criteria text,
  contact text,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now())
);

-- 创建 admin_users 表
CREATE TABLE admin_users (
  user_id text PRIMARY KEY,
  role text NOT NULL CHECK (role IN ('super_admin', 'data_admin'))
);

-- 创建 logs 表
CREATE TABLE logs (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  user_id text,
  user_email text,
  action text,
  details jsonb
);

-- 启用 RLS 策略
ALTER TABLE trials ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Allow public read access" ON trials FOR SELECT USING (true);
CREATE POLICY "Allow authenticated insert" ON trials FOR INSERT WITH CHECK (auth.role() = 'authenticated');
CREATE POLICY "Allow authenticated update" ON trials FOR UPDATE USING (auth.role() = 'authenticated');
CREATE POLICY "Allow authenticated delete" ON trials FOR DELETE USING (auth.role() = 'authenticated');

ALTER TABLE admin_users ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Allow authenticated read" ON admin_users FOR SELECT USING (auth.role() = 'authenticated');

ALTER TABLE logs ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Allow authenticated insert" ON logs FOR INSERT WITH CHECK (auth.role() = 'authenticated');
CREATE POLICY "Allow authenticated read" ON logs FOR SELECT USING (auth.role() = 'authenticated');
```

3. **配置认证**
   - 在 Authentication 页面启用 Email/Password 认证
   - 添加管理员邮箱账号
   - 在 `admin_users` 表中为管理员账号设置相应角色

## 使用指南

### 🔍 临床试验搜索

1. 打开系统首页
2. 在搜索框中输入关键词（疾病名称、研究者姓名或项目标题）
3. 系统会实时显示匹配的临床试验项目
4. 点击项目卡片查看详细信息

### 👑 管理员功能

1. **登录管理员**
   - 点击右上角的"管理员登录"按钮
   - 输入管理员邮箱和密码
   - 登录后自动进入管理员工作台

2. **项目管理**
   - 在"项目列表管理"页面查看所有临床试验项目
   - 点击项目卡片编辑现有项目
   - 点击"+ 新增试验"创建新项目
   - 点击"导出数据"下载 CSV 格式数据
   - 点击"导入数据"从 CSV 文件批量导入数据

3. **用户管理**（超级管理员）
   - 在"管理员架构"页面查看所有管理员账号
   - 查看各管理员的角色权限

4. **系统日志**（超级管理员）
   - 在"系统操作日志"页面查看所有管理员操作记录
   - 查看操作详情和时间

### 📤 数据导入

1. 在管理员工作台点击"导入数据"按钮
2. 选择或拖拽 CSV 格式的文件到上传区域
3. 点击"开始导入"按钮
4. 系统会自动解析并导入数据，显示实时进度
5. 导入完成后会显示成功提示

#### CSV 文件格式要求

```csv
科室,研究者(PI),项目标题,适应症,标签,详细标准,联系方式
肿瘤内科,张医生,肺癌靶向治疗临床试验,肺癌,靶向治疗;晚期,1. 年龄18-75岁\n2. 经病理证实的晚期肺癌,联系人：李护士\n电话：13800138000
心血管内科,王医生,高血压新药临床试验,高血压,新药;二期,1. 年龄30-65岁\n2. 确诊高血压2年以上,联系人：赵护士\n电话：13900139000
```

- 支持中文和英文表头
- 标签使用分号(`;`)分隔
- 多行文本使用`\n`表示
- 至少需要提供标题、适应症或研究者中的一项

## 技术架构

### 前端技术栈

- **React 19.2.4**：现代化前端框架
- **TypeScript 5.8.2**：类型安全的 JavaScript 超集
- **Vite 6.2.0**：快速的前端构建工具
- **Supabase JS**：与 Supabase 数据库交互
- **Google GenAI**：AI 相关功能支持

### 后端服务

- **Supabase**：提供数据库、认证和存储服务
  - PostgreSQL 数据库
  - JWT 认证系统
  - 实时数据同步

### 安全特性

- **JWT 认证**：基于令牌的安全认证机制
- **权限控制**：基于角色的访问控制（RBAC）
- **数据验证**：前端和后端双重数据验证
- **审计日志**：记录所有敏感操作

## 开发指南

### 目录结构

- **components/**：React 组件
- **lib/**：工具库和配置文件
- **services/**：外部服务集成

### 核心组件

- **App.tsx**：主应用组件，管理路由和状态
- **AdminDashboard.tsx**：管理员工作台，包含项目管理、用户管理和日志查看
- **AdminLogin.tsx**：管理员登录组件
- **SearchBox.tsx**：搜索框组件
- **TrialCard.tsx**：临床试验项目卡片
- **TrialDetail.tsx**：临床试验项目详情

### 类型定义

主要类型定义位于 `types.ts` 文件：

- `Trial`：临床试验项目类型
- `UserRole`：用户角色类型
- `LogEntry`：系统日志类型

## 常见问题

### 1. 登录失败

**问题**：管理员登录失败，提示"邮箱或密码错误"

**解决方法**：
- 确认邮箱和密码正确
- 确认该邮箱已在 Supabase 控制台中注册
- 确认该邮箱已在 `admin_users` 表中添加并设置了正确的角色

### 2. 数据导入失败

**问题**：CSV 文件导入失败

**解决方法**：
- 确认 CSV 文件格式正确
- 检查文件编码是否为 UTF-8
- 确保表头格式正确（支持中文或英文）
- 检查数据内容是否符合要求

### 3. 数据库连接错误

**问题**：系统提示"数据库配置错误"

**解决方法**：
- 确认 Supabase URL 和 Anon Key 配置正确
- 检查网络连接
- 确认 Supabase 项目状态正常
- 确认数据表结构已正确创建

## 注意事项

1. **安全性**：
   - 不要在代码中硬编码 Supabase 密钥
   - 使用环境变量管理敏感配置
   - 定期更新管理员密码

2. **性能**：
   - 对于大量数据导入，建议分批处理
   - 优化数据库查询，考虑添加索引
   - 定期清理无用数据

3. **维护**：
   - 定期备份数据库
   - 监控系统日志，及时发现异常操作
   - 保持依赖包更新

## 许可证

本项目采用 MIT 许可证。详见 [LICENSE](LICENSE) 文件。

## 贡献

欢迎对项目提出建议和改进！如有问题或建议，请提交 Issue 或 Pull Request。

## 联系方式

- **项目维护**：ClinData 开发团队
- **技术支持**：support@clindata.example.com

---

**版本**：1.0.0
**更新日期**：2026-02-02
**状态**：活跃开发中